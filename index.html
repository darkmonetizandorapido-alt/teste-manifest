<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ora√ß√µes Cat√≥licas e Novenas - PWA Corrigido</title>
    
    <!-- PWA MANIFEST - OBRIGAT√ìRIO -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#264580">
    
    <!-- √çCONES -->
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/icon-192.png">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .status-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .status-icon {
            font-size: 24px;
        }
        
        button {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30,60,114,0.3);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #pwa-status {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <h1>üôè Ora√ß√µes Cat√≥licas e Novenas</h1>
    <p>Sistema PWA com Modal de Instala√ß√£o Corrigido</p>
    
    <!-- STATUS DO PWA -->
    <div class="status-box">
        <h2>üìä Status do PWA</h2>
        <div id="status-checklist"></div>
    </div>
    
    <!-- BOT√ïES DE A√á√ÉO -->
    <div class="status-box">
        <h2>üéÆ A√ß√µes</h2>
        <button id="btn-verificar" onclick="verificarTudo()">
            üîç Verificar Status Completo
        </button>
        <button id="btn-instalar-manual" onclick="instalarAppManual()">
            üì≤ Instalar App Manualmente
        </button>
        <button onclick="ativarNotificacoes()">
            üîî Ativar Notifica√ß√µes
        </button>
        <button onclick="limparCache()">
            üóëÔ∏è Limpar Cache e Recarregar
        </button>
    </div>
    
    <!-- LOGS -->
    <div class="status-box">
        <h2>üìù Logs do Console</h2>
        <div id="pwa-status"></div>
    </div>
    
    <!-- MODAL DE INSTALA√á√ÉO -->
    <div id="modal-instalar" style="
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 99999;
    ">
        <div style="
            background: #fff;
            max-width: 420px;
            width: 90%;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        ">
            <h2 style="color:#1e3c72; margin-bottom:15px;">
                üôè Leve a Palavra de Deus com voc√™
            </h2>
            
            <p style="color:#444; line-height:1.6; margin-bottom:20px;">
                Instale nosso aplicativo para ter acesso r√°pido a ora√ß√µes,
                novenas e a Palavra de Deus todos os dias!
            </p>
            
            <button id="btn-instalar-modal">
                üì≤ Instalar Aplicativo
            </button>
            
            <button onclick="fecharModalInstalar()" style="
                background: #ccc;
                color: #333;
            ">
                Agora n√£o
            </button>
        </div>
    </div>
    
    <!-- SCRIPTS PWA -->
    <script>
        // ==========================================
        // CONFIGURA√á√ÉO
        // ==========================================
        let deferredPrompt = null;
        const PWA_DEBUG = true;
        
        // ==========================================
        // SISTEMA DE LOGS
        // ==========================================
        function addLog(message, type = 'info') {
            const statusDiv = document.getElementById('pwa-status');
            const timestamp = new Date().toLocaleTimeString();
            
            const colors = {
                info: '#2196F3',
                success: '#4CAF50',
                warning: '#FF9800',
                error: '#F44336'
            };
            
            const log = document.createElement('div');
            log.style.color = colors[type] || colors.info;
            log.textContent = `[${timestamp}] ${message}`;
            statusDiv.appendChild(log);
            statusDiv.scrollTop = statusDiv.scrollHeight;
            
            // Tamb√©m logar no console
            console.log(`%c[PWA] ${message}`, `color: ${colors[type]}; font-weight: bold`);
        }
        
        // ==========================================
        // VERIFICAR REQUISITOS
        // ==========================================
        function verificarTudo() {
            addLog('üîç Iniciando verifica√ß√£o completa...', 'info');
            
            const checklist = {
                'HTTPS/Localhost': window.location.protocol === 'https:' || window.location.hostname === 'localhost',
                'Service Worker Suportado': 'serviceWorker' in navigator,
                'Service Worker Ativo': !!navigator.serviceWorker.controller,
                'Manifest Presente': !!document.querySelector('link[rel="manifest"]'),
                'Notifica√ß√µes Suportadas': 'Notification' in window,
                'Permiss√£o de Notifica√ß√£o': Notification.permission,
                'beforeinstallprompt Capturado': !!deferredPrompt,
                'App em Standalone': window.matchMedia('(display-mode: standalone)').matches
            };
            
            const checklistDiv = document.getElementById('status-checklist');
            checklistDiv.innerHTML = '';
            
            for (const [key, value] of Object.entries(checklist)) {
                const item = document.createElement('div');
                item.className = 'status-item';
                
                let icon = '‚ùå';
                let status = value;
                
                if (typeof value === 'boolean') {
                    icon = value ? '‚úÖ' : '‚ùå';
                    status = value ? 'Sim' : 'N√£o';
                }
                
                item.innerHTML = `
                    <span class="status-icon">${icon}</span>
                    <strong>${key}:</strong>
                    <span>${status}</span>
                `;
                
                checklistDiv.appendChild(item);
                addLog(`${icon} ${key}: ${status}`, value ? 'success' : 'warning');
            }
            
            addLog('‚úÖ Verifica√ß√£o conclu√≠da', 'success');
        }
        
        // ==========================================
        // MODAL
        // ==========================================
        function mostrarModalInstalar() {
            const modal = document.getElementById("modal-instalar");
            if (modal) {
                modal.style.display = "flex";
                addLog('üì± Modal de instala√ß√£o exibido', 'success');
            }
        }
        
        function fecharModalInstalar() {
            const modal = document.getElementById("modal-instalar");
            if (modal) {
                modal.style.display = "none";
                addLog('‚úñÔ∏è Modal fechado', 'info');
            }
        }
        
        // ==========================================
        // INSTALA√á√ÉO
        // ==========================================
        async function instalarAppManual() {
            if (!deferredPrompt) {
                addLog('‚ö†Ô∏è Prompt de instala√ß√£o n√£o dispon√≠vel', 'warning');
                addLog('Poss√≠veis causas:', 'warning');
                addLog('- App j√° instalado', 'warning');
                addLog('- beforeinstallprompt n√£o disparou', 'warning');
                addLog('- Navegador n√£o suporta', 'warning');
                
                // Tentar mostrar modal de qualquer forma
                mostrarModalInstalar();
                return;
            }
            
            try {
                addLog('üì≤ Solicitando instala√ß√£o...', 'info');
                deferredPrompt.prompt();
                
                const choiceResult = await deferredPrompt.userChoice;
                
                if (choiceResult.outcome === 'accepted') {
                    addLog('‚úÖ Usu√°rio aceitou instalar!', 'success');
                } else {
                    addLog('‚ùå Usu√°rio recusou a instala√ß√£o', 'warning');
                }
                
                deferredPrompt = null;
                fecharModalInstalar();
                
            } catch (error) {
                addLog(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        // ==========================================
        // NOTIFICA√á√ïES
        // ==========================================
        async function ativarNotificacoes() {
            if (!("Notification" in window)) {
                addLog('‚ùå Notifica√ß√µes n√£o suportadas', 'error');
                return;
            }
            
            try {
                const permission = await Notification.requestPermission();
                addLog(`üîî Permiss√£o: ${permission}`, permission === 'granted' ? 'success' : 'warning');
                
                if (permission === 'granted') {
                    new Notification('‚úÖ Notifica√ß√µes Ativadas!', {
                        body: 'Voc√™ receber√° atualiza√ß√µes de ora√ß√µes e novenas',
                        icon: '/icon-192.png'
                    });
                }
            } catch (error) {
                addLog(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        // ==========================================
        // CACHE
        // ==========================================
        async function limparCache() {
            try {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    addLog('‚úÖ Cache limpo', 'success');
                }
                
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                    addLog('‚úÖ Service Workers desregistrados', 'success');
                }
                
                addLog('üîÑ Recarregando p√°gina...', 'info');
                setTimeout(() => window.location.reload(), 1000);
                
            } catch (error) {
                addLog(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        // ==========================================
        // SERVICE WORKER
        // ==========================================
        async function registrarServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                addLog('‚ùå Service Worker n√£o suportado', 'error');
                return;
            }
            
            try {
                addLog('üìù Registrando Service Worker...', 'info');
                
                const registration = await navigator.serviceWorker.register('/service-worker.js', {
                    scope: '/'
                });
                
                addLog('‚úÖ Service Worker registrado', 'success');
                addLog(`   Scope: ${registration.scope}`, 'info');
                
                return registration;
                
            } catch (error) {
                addLog(`‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        // ==========================================
        // EVENTOS
        // ==========================================
        window.addEventListener("beforeinstallprompt", (e) => {
            addLog('üéâ beforeinstallprompt capturado!', 'success');
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar modal ap√≥s 3 segundos
            setTimeout(() => {
                mostrarModalInstalar();
            }, 3000);
        });
        
        window.addEventListener('appinstalled', () => {
            addLog('üéä App instalado com sucesso!', 'success');
            fecharModalInstalar();
        });
        
        // ==========================================
        // INICIALIZA√á√ÉO
        // ==========================================
        window.addEventListener('load', async () => {
            addLog('üöÄ Iniciando sistema PWA...', 'info');
            
            await registrarServiceWorker();
            verificarTudo();
            
            // Configurar bot√µes
            document.getElementById('btn-instalar-modal')?.addEventListener('click', instalarAppManual);
            
            addLog('‚ú® Sistema inicializado!', 'success');
            
            // Status ap√≥s 5 segundos
            setTimeout(() => {
                addLog('üìä Status final:', 'info');
                addLog(`   Prompt dispon√≠vel: ${deferredPrompt ? 'SIM' : 'N√ÉO'}`, deferredPrompt ? 'success' : 'warning');
            }, 5000);
        });
    </script>
</body>
</html>
