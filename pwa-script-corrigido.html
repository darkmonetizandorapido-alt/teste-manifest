<!-- ===============================
 PWA SCRIPT CORRIGIDO COM DEBUG
=============================== -->
<script>
// ==========================================
// CONFIGURA√á√ÉO E VARI√ÅVEIS GLOBAIS
// ==========================================
let deferredPrompt = null;
const PWA_DEBUG = true; // Ativar logs detalhados

function log(message, type = 'info') {
  if (!PWA_DEBUG) return;
  
  const styles = {
    info: 'color: #2196F3; font-weight: bold',
    success: 'color: #4CAF50; font-weight: bold',
    warning: 'color: #FF9800; font-weight: bold',
    error: 'color: #F44336; font-weight: bold'
  };
  
  console.log(`%c[PWA] ${message}`, styles[type] || styles.info);
}

// ==========================================
// VERIFICAR REQUISITOS PWA
// ==========================================
function verificarRequisitosPWA() {
  log('üîç Verificando requisitos PWA...', 'info');
  
  const requisitos = {
    https: window.location.protocol === 'https:' || window.location.hostname === 'localhost',
    serviceWorker: 'serviceWorker' in navigator,
    manifest: document.querySelector('link[rel="manifest"]') !== null,
    beforeInstallPrompt: true // Ser√° verificado no evento
  };
  
  log(`üìã Checklist PWA:`, 'info');
  log(`  ‚úì HTTPS/Localhost: ${requisitos.https ? '‚úÖ' : '‚ùå'}`, requisitos.https ? 'success' : 'error');
  log(`  ‚úì Service Worker: ${requisitos.serviceWorker ? '‚úÖ' : '‚ùå'}`, requisitos.serviceWorker ? 'success' : 'error');
  log(`  ‚úì Manifest: ${requisitos.manifest ? '‚úÖ' : '‚ùå'}`, requisitos.manifest ? 'success' : 'error');
  
  const todosOk = Object.values(requisitos).every(r => r);
  
  if (!todosOk) {
    log('‚ö†Ô∏è Alguns requisitos PWA n√£o foram atendidos!', 'warning');
  }
  
  return requisitos;
}

// ==========================================
// REGISTRAR SERVICE WORKER
// ==========================================
async function registrarServiceWorker() {
  if (!('serviceWorker' in navigator)) {
    log('‚ùå Service Worker n√£o suportado neste navegador', 'error');
    return null;
  }
  
  try {
    log('üìù Registrando Service Worker...', 'info');
    
    const registration = await navigator.serviceWorker.register('/service-worker.js', {
      scope: '/'
    });
    
    log('‚úÖ Service Worker registrado com sucesso', 'success');
    log(`   Scope: ${registration.scope}`, 'info');
    
    // Verificar estado do service worker
    if (registration.installing) {
      log('   Estado: Instalando...', 'info');
    } else if (registration.waiting) {
      log('   Estado: Aguardando...', 'warning');
    } else if (registration.active) {
      log('   Estado: Ativo ‚úÖ', 'success');
    }
    
    // Listener para atualiza√ß√µes
    registration.addEventListener('updatefound', () => {
      log('üîÑ Nova vers√£o do Service Worker encontrada', 'info');
      const newWorker = registration.installing;
      
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          log('‚ú® Nova vers√£o instalada e pronta', 'success');
        }
      });
    });
    
    return registration;
    
  } catch (error) {
    log(`‚ùå Erro ao registrar Service Worker: ${error.message}`, 'error');
    console.error(error);
    return null;
  }
}

// ==========================================
// MODAL DE INSTALA√á√ÉO
// ==========================================
function mostrarModalInstalar() {
  const modal = document.getElementById("modal-instalar");
  if (modal) {
    modal.style.display = "flex";
    log('üì± Modal de instala√ß√£o exibido', 'info');
  }
}

function fecharModalInstalar() {
  const modal = document.getElementById("modal-instalar");
  if (modal) {
    modal.style.display = "none";
    log('‚úñÔ∏è Modal de instala√ß√£o fechado', 'info');
  }
}

// ==========================================
// EVENTO BEFOREINSTALLPROMPT
// ==========================================
window.addEventListener("beforeinstallprompt", (e) => {
  log('üéâ Evento beforeinstallprompt capturado!', 'success');
  
  e.preventDefault();
  deferredPrompt = e;
  
  // Mostrar bot√£o de instala√ß√£o no nav
  const installBtnNav = document.getElementById("install-btn-nav");
  if (installBtnNav) {
    installBtnNav.style.display = "inline-block";
    log('‚úÖ Bot√£o de instala√ß√£o no nav exibido', 'success');
  }
  
  // Mostrar modal ap√≥s 3 segundos
  setTimeout(() => {
    mostrarModalInstalar();
  }, 3000);
});

// ==========================================
// INSTALA√á√ÉO DO APP
// ==========================================
async function instalarApp() {
  if (!deferredPrompt) {
    log('‚ö†Ô∏è Prompt de instala√ß√£o n√£o dispon√≠vel', 'warning');
    log('   Poss√≠veis causas:', 'warning');
    log('   - App j√° instalado', 'warning');
    log('   - beforeinstallprompt n√£o disparou ainda', 'warning');
    log('   - Navegador n√£o suporta instala√ß√£o', 'warning');
    return;
  }
  
  try {
    log('üì≤ Solicitando instala√ß√£o do app...', 'info');
    
    deferredPrompt.prompt();
    
    const choiceResult = await deferredPrompt.userChoice;
    
    if (choiceResult.outcome === 'accepted') {
      log('‚úÖ Usu√°rio aceitou instalar o app!', 'success');
    } else {
      log('‚ùå Usu√°rio recusou a instala√ß√£o', 'warning');
    }
    
    deferredPrompt = null;
    fecharModalInstalar();
    
  } catch (error) {
    log(`‚ùå Erro ao instalar app: ${error.message}`, 'error');
    console.error(error);
  }
}

// ==========================================
// APP INSTALADO
// ==========================================
window.addEventListener('appinstalled', (evt) => {
  log('üéä App instalado com sucesso!', 'success');
  fecharModalInstalar();
  
  // Ativar notifica√ß√µes ap√≥s instala√ß√£o
  setTimeout(() => {
    ativarNotificacoes();
  }, 1000);
});

// ==========================================
// INICIALIZA√á√ÉO
// ==========================================
window.addEventListener('load', async () => {
  log('üöÄ Iniciando PWA...', 'info');
  
  // Verificar requisitos
  const requisitos = verificarRequisitosPWA();
  
  // Registrar service worker
  await registrarServiceWorker();
  
  // Configurar bot√£o de instala√ß√£o
  const btnInstalar = document.getElementById("btn-instalar");
  if (btnInstalar) {
    btnInstalar.addEventListener("click", instalarApp);
    log('‚úÖ Bot√£o de instala√ß√£o configurado', 'success');
  }
  
  // Configurar bot√£o do nav
  const installBtnNav = document.getElementById("install-btn-nav");
  if (installBtnNav) {
    installBtnNav.addEventListener("click", (e) => {
      e.preventDefault();
      mostrarModalInstalar();
    });
  }
  
  // Verificar se j√° est√° instalado
  if (window.matchMedia('(display-mode: standalone)').matches) {
    log('‚úÖ App j√° est√° instalado e rodando em modo standalone', 'success');
  } else {
    log('‚ÑπÔ∏è App n√£o est√° instalado', 'info');
  }
  
  log('‚ú® PWA inicializado com sucesso!', 'success');
});

// ==========================================
// DEBUG: STATUS DO PWA
// ==========================================
if (PWA_DEBUG) {
  setTimeout(() => {
    log('üìä Status do PWA ap√≥s 5 segundos:', 'info');
    log(`   Prompt dispon√≠vel: ${deferredPrompt ? '‚úÖ' : '‚ùå'}`, deferredPrompt ? 'success' : 'warning');
    log(`   Service Worker: ${navigator.serviceWorker.controller ? '‚úÖ Ativo' : '‚ùå Inativo'}`, 
        navigator.serviceWorker.controller ? 'success' : 'warning');
  }, 5000);
}
</script>

<!-- ===============================
 FIREBASE MESSAGING
=============================== -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

<script>
// ==========================================
// FIREBASE CONFIGURATION
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyCPW3KiSuOR1ZNr_xPj0-CQL2LRcImjV3E",
  authDomain: "pwa-oracoes.firebaseapp.com",
  projectId: "pwa-oracoes",
  storageBucket: "pwa-oracoes.firebasestorage.app",
  messagingSenderId: "729009444214",
  appId: "1:729009444214:web:c2eb3ccaf9612f90375657"
};

window.messaging = null;

// ==========================================
// INICIALIZAR FIREBASE
// ==========================================
window.addEventListener('load', function() {
  try {
    if (typeof firebase === 'undefined') {
      log('‚ùå Firebase SDK n√£o carregado', 'error');
      return;
    }

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
      log('‚úÖ Firebase inicializado', 'success');
    }
    
    if (firebase.messaging.isSupported()) {
      window.messaging = firebase.messaging();
      log('‚úÖ Firebase Messaging pronto', 'success');
      
      // Listener para mensagens em foreground
      window.messaging.onMessage((payload) => {
        log('üì© Mensagem recebida em foreground', 'info');
        
        const notificationTitle = payload.notification?.title || 'Nova Ora√ß√£o';
        const notificationOptions = {
          body: payload.notification?.body || 'Confira agora!',
          icon: '/icon-192.png',
          badge: '/icon-192.png',
          vibrate: [200, 100, 200],
          tag: 'oracao-notification'
        };
        
        if (Notification.permission === 'granted') {
          new Notification(notificationTitle, notificationOptions);
        }
      });
    } else {
      log('‚ö†Ô∏è Firebase Messaging n√£o suportado', 'warning');
    }
  } catch (error) {
    log(`‚ùå Erro ao inicializar Firebase: ${error.message}`, 'error');
  }
});

// ==========================================
// ATIVAR NOTIFICA√á√ïES
// ==========================================
async function ativarNotificacoes() {
  try {
    if (!("Notification" in window)) {
      log('‚ö†Ô∏è Notifica√ß√µes n√£o suportadas', 'warning');
      return;
    }

    if (!window.messaging) {
      log('‚ö†Ô∏è Firebase Messaging n√£o inicializado', 'warning');
      return;
    }

    // Solicitar permiss√£o
    const permission = await Notification.requestPermission();
    
    if (permission !== 'granted') {
      log('‚ùå Permiss√£o de notifica√ß√£o negada', 'warning');
      return;
    }

    log('‚úÖ Permiss√£o concedida', 'success');

    // Aguardar Service Worker
    const registration = await navigator.serviceWorker.ready;

    // Obter token FCM
    const token = await window.messaging.getToken({
      vapidKey: "BPhFeTsT5gEsLsZZCGaUFSsqS_9b9FT3F87cLVmH24LtZKQ88i013R7kTEfN4Miq9CIbKPIrd6hnEUlm7UcbxxI",
      serviceWorkerRegistration: registration
    });

    if (token) {
      log(`üî• Token FCM: ${token.substring(0, 20)}...`, 'success');
      localStorage.setItem('fcm_token', token);
      return token;
    } else {
      log('‚ö†Ô∏è N√£o foi poss√≠vel obter token FCM', 'warning');
    }
  } catch (error) {
    log(`‚ùå Erro ao ativar notifica√ß√µes: ${error.message}`, 'error');
  }
}
</script>
