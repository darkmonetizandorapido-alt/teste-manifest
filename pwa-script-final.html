<!-- ===============================
 PWA SCRIPT - VERS√ÉO CORRIGIDA FINAL
 - Aguarda SW ficar ativo
 - Reload autom√°tico se necess√°rio
 - Verifica√ß√µes constantes
=============================== -->
<script>
// ==========================================
// CONFIGURA√á√ÉO
// ==========================================
let deferredPrompt = null;
const PWA_DEBUG = true;

// ==========================================
// SISTEMA DE LOGS
// ==========================================
function addLog(message, type = 'info') {
    const statusDiv = document.getElementById('pwa-status');
    if (!statusDiv) {
        console.log(`[PWA] ${message}`);
        return;
    }
    
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
        info: '#2196F3',
        success: '#4CAF50',
        warning: '#FF9800',
        error: '#F44336'
    };
    
    const log = document.createElement('div');
    log.style.color = colors[type] || colors.info;
    log.textContent = `[${timestamp}] ${message}`;
    statusDiv.appendChild(log);
    statusDiv.scrollTop = statusDiv.scrollHeight;
    
    console.log(`%c[PWA] ${message}`, `color: ${colors[type]}; font-weight: bold`);
}

// ==========================================
// AGUARDAR SERVICE WORKER FICAR ATIVO
// ==========================================
async function aguardarServiceWorkerAtivo() {
    if (!('serviceWorker' in navigator)) {
        addLog('‚ùå Service Worker n√£o suportado', 'error');
        return false;
    }
    
    addLog('‚è≥ Aguardando Service Worker ficar ativo...', 'info');
    
    try {
        // Aguardar at√© que o SW esteja pronto
        const registration = await navigator.serviceWorker.ready;
        addLog('‚úÖ Service Worker est√° pronto!', 'success');
        
        // Verificar se est√° controlando a p√°gina
        if (navigator.serviceWorker.controller) {
            addLog('üëë Service Worker est√° controlando a p√°gina', 'success');
            return true;
        } else {
            addLog('‚ö†Ô∏è SW pronto mas n√£o est√° controlando ainda', 'warning');
            addLog('üîÑ Recarregando p√°gina para ativar...', 'info');
            
            // Aguardar um pouco antes de recarregar
            setTimeout(() => {
                window.location.reload();
            }, 1000);
            
            return false;
        }
    } catch (error) {
        addLog(`‚ùå Erro ao aguardar SW: ${error.message}`, 'error');
        return false;
    }
}

// ==========================================
// REGISTRAR SERVICE WORKER
// ==========================================
async function registrarServiceWorker() {
    if (!('serviceWorker' in navigator)) {
        addLog('‚ùå Service Worker n√£o suportado', 'error');
        return null;
    }
    
    try {
        addLog('üìù Registrando Service Worker...', 'info');
        
        const registration = await navigator.serviceWorker.register('/service-worker.js', {
            scope: '/',
            updateViaCache: 'none' // Sempre buscar vers√£o mais recente
        });
        
        addLog('‚úÖ Service Worker registrado', 'success');
        addLog(`   Scope: ${registration.scope}`, 'info');
        
        // Verificar estado atual
        if (registration.installing) {
            addLog('   Estado: Instalando...', 'info');
        } else if (registration.waiting) {
            addLog('   Estado: Aguardando... (recarregue a p√°gina)', 'warning');
        } else if (registration.active) {
            addLog('   Estado: Ativo ‚úÖ', 'success');
        }
        
        // Listener para atualiza√ß√µes
        registration.addEventListener('updatefound', () => {
            addLog('üîÑ Nova vers√£o encontrada', 'info');
            const newWorker = registration.installing;
            
            newWorker.addEventListener('statechange', () => {
                addLog(`   Novo estado: ${newWorker.state}`, 'info');
                
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    addLog('‚ú® Nova vers√£o pronta! Recarregue para atualizar', 'success');
                }
            });
        });
        
        // Listener para mensagens do SW
        navigator.serviceWorker.addEventListener('message', (event) => {
            addLog(`üí¨ Mensagem do SW: ${event.data.type}`, 'info');
            
            if (event.data.type === 'SW_ACTIVATED') {
                addLog('üéâ Service Worker confirmou ativa√ß√£o!', 'success');
                verificarInstalabilidade();
            }
        });
        
        return registration;
        
    } catch (error) {
        addLog(`‚ùå Erro ao registrar SW: ${error.message}`, 'error');
        console.error(error);
        return null;
    }
}

// ==========================================
// VERIFICAR SE PODE INSTALAR
// ==========================================
async function verificarInstalabilidade() {
    addLog('üîç Verificando instalabilidade...', 'info');
    
    // Aguardar SW estar ativo
    const swAtivo = await aguardarServiceWorkerAtivo();
    
    if (!swAtivo) {
        addLog('‚ö†Ô∏è SW n√£o est√° ativo, instala√ß√£o n√£o dispon√≠vel ainda', 'warning');
        return;
    }
    
    // Verificar se j√° est√° instalado
    if (window.matchMedia('(display-mode: standalone)').matches) {
        addLog('‚úÖ App j√° est√° instalado!', 'success');
        return;
    }
    
    // Verificar se prompt est√° dispon√≠vel
    if (deferredPrompt) {
        addLog('‚úÖ Prompt de instala√ß√£o dispon√≠vel!', 'success');
        
        // Mostrar modal automaticamente ap√≥s 3 segundos
        setTimeout(() => {
            mostrarModalInstalar();
        }, 3000);
    } else {
        addLog('‚è≥ Aguardando evento beforeinstallprompt...', 'info');
        
        // Tentar novamente ap√≥s alguns segundos
        setTimeout(verificarInstalabilidade, 2000);
    }
}

// ==========================================
// VERIFICAR REQUISITOS
// ==========================================
function verificarTudo() {
    addLog('üîç Iniciando verifica√ß√£o completa...', 'info');
    
    const checklist = {
        'HTTPS/Localhost': window.location.protocol === 'https:' || window.location.hostname === 'localhost',
        'Service Worker Suportado': 'serviceWorker' in navigator,
        'Service Worker Ativo': !!navigator.serviceWorker.controller,
        'Manifest Presente': !!document.querySelector('link[rel="manifest"]'),
        'Notifica√ß√µes Suportadas': 'Notification' in window,
        'Permiss√£o de Notifica√ß√£o': Notification.permission,
        'beforeinstallprompt Capturado': !!deferredPrompt,
        'App em Standalone': window.matchMedia('(display-mode: standalone)').matches
    };
    
    const checklistDiv = document.getElementById('status-checklist');
    if (checklistDiv) {
        checklistDiv.innerHTML = '';
        
        for (const [key, value] of Object.entries(checklist)) {
            const item = document.createElement('div');
            item.className = 'status-item';
            
            let icon = '‚ùå';
            let status = value;
            
            if (typeof value === 'boolean') {
                icon = value ? '‚úÖ' : '‚ùå';
                status = value ? 'Sim' : 'N√£o';
            }
            
            item.innerHTML = `
                <span class="status-icon">${icon}</span>
                <strong>${key}:</strong>
                <span>${status}</span>
            `;
            
            checklistDiv.appendChild(item);
            addLog(`${icon} ${key}: ${status}`, value ? 'success' : 'warning');
        }
    }
    
    addLog('‚úÖ Verifica√ß√£o conclu√≠da', 'success');
    
    // Se tudo OK mas prompt n√£o disparou
    if (checklist['HTTPS/Localhost'] && 
        checklist['Service Worker Ativo'] && 
        checklist['Manifest Presente'] && 
        !checklist['beforeinstallprompt Capturado'] &&
        !checklist['App em Standalone']) {
        
        addLog('‚ö†Ô∏è Requisitos OK mas prompt n√£o disparou', 'warning');
        addLog('üí° Poss√≠veis causas:', 'info');
        addLog('   - Chrome: precisa de engajamento do usu√°rio', 'info');
        addLog('   - Navegador n√£o suporta instala√ß√£o', 'info');
        addLog('   - J√° foi instalado antes e desinstalado', 'info');
    }
}

// ==========================================
// MODAL
// ==========================================
function mostrarModalInstalar() {
    const modal = document.getElementById("modal-instalar");
    if (modal) {
        modal.style.display = "flex";
        addLog('üì± Modal de instala√ß√£o exibido', 'success');
    }
}

function fecharModalInstalar() {
    const modal = document.getElementById("modal-instalar");
    if (modal) {
        modal.style.display = "none";
        addLog('‚úñÔ∏è Modal fechado', 'info');
    }
}

// ==========================================
// INSTALA√á√ÉO
// ==========================================
async function instalarAppManual() {
    if (!deferredPrompt) {
        addLog('‚ö†Ô∏è Prompt de instala√ß√£o n√£o dispon√≠vel', 'warning');
        addLog('Poss√≠veis solu√ß√µes:', 'info');
        addLog('1. Aguardar alguns segundos', 'info');
        addLog('2. Interagir com o site (clicar, rolar)', 'info');
        addLog('3. Usar menu do navegador: Menu ‚Üí Instalar', 'info');
        
        mostrarModalInstalar();
        return;
    }
    
    try {
        addLog('üì≤ Solicitando instala√ß√£o...', 'info');
        deferredPrompt.prompt();
        
        const choiceResult = await deferredPrompt.userChoice;
        
        if (choiceResult.outcome === 'accepted') {
            addLog('‚úÖ Usu√°rio aceitou instalar!', 'success');
        } else {
            addLog('‚ùå Usu√°rio recusou a instala√ß√£o', 'warning');
        }
        
        deferredPrompt = null;
        fecharModalInstalar();
        
    } catch (error) {
        addLog(`‚ùå Erro: ${error.message}`, 'error');
    }
}

// ==========================================
// EVENTOS
// ==========================================
window.addEventListener("beforeinstallprompt", (e) => {
    addLog('üéâ beforeinstallprompt capturado!', 'success');
    e.preventDefault();
    deferredPrompt = e;
    
    // Atualizar checklist
    verificarTudo();
    
    // Mostrar modal ap√≥s 3 segundos
    setTimeout(() => {
        mostrarModalInstalar();
    }, 3000);
});

window.addEventListener('appinstalled', () => {
    addLog('üéä App instalado com sucesso!', 'success');
    fecharModalInstalar();
    
    // Ativar notifica√ß√µes
    setTimeout(() => {
        if (typeof ativarNotificacoes === 'function') {
            ativarNotificacoes();
        }
    }, 1000);
});

// ==========================================
// NOTIFICA√á√ïES
// ==========================================
async function ativarNotificacoes() {
    if (!("Notification" in window)) {
        addLog('‚ùå Notifica√ß√µes n√£o suportadas', 'error');
        return;
    }
    
    try {
        const permission = await Notification.requestPermission();
        addLog(`üîî Permiss√£o: ${permission}`, permission === 'granted' ? 'success' : 'warning');
        
        if (permission === 'granted') {
            new Notification('‚úÖ Notifica√ß√µes Ativadas!', {
                body: 'Voc√™ receber√° atualiza√ß√µes de ora√ß√µes e novenas',
                icon: '/icon-192.png'
            });
        }
    } catch (error) {
        addLog(`‚ùå Erro: ${error.message}`, 'error');
    }
}

// ==========================================
// LIMPAR CACHE
// ==========================================
async function limparCache() {
    try {
        addLog('üóëÔ∏è Limpando cache...', 'info');
        
        if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            addLog('‚úÖ Cache limpo', 'success');
        }
        
        if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            await Promise.all(registrations.map(reg => reg.unregister()));
            addLog('‚úÖ Service Workers desregistrados', 'success');
        }
        
        addLog('üîÑ Recarregando em 1 segundo...', 'info');
        setTimeout(() => window.location.reload(true), 1000);
        
    } catch (error) {
        addLog(`‚ùå Erro: ${error.message}`, 'error');
    }
}

// ==========================================
// INICIALIZA√á√ÉO
// ==========================================
window.addEventListener('load', async () => {
    addLog('üöÄ Iniciando sistema PWA...', 'info');
    
    // 1. Registrar Service Worker
    await registrarServiceWorker();
    
    // 2. Aguardar SW ficar ativo
    const swAtivo = await aguardarServiceWorkerAtivo();
    
    // 3. Verificar tudo
    verificarTudo();
    
    // 4. Configurar bot√µes
    const btnInstalar = document.getElementById('btn-instalar');
    const btnInstalarModal = document.getElementById('btn-instalar-modal');
    
    if (btnInstalar) {
        btnInstalar.addEventListener('click', instalarAppManual);
    }
    
    if (btnInstalarModal) {
        btnInstalarModal.addEventListener('click', instalarAppManual);
    }
    
    addLog('‚ú® Sistema inicializado!', 'success');
    
    // 5. Verificar instalabilidade ap√≥s tudo carregar
    if (swAtivo) {
        setTimeout(verificarInstalabilidade, 2000);
    }
    
    // 6. Status ap√≥s 5 segundos
    setTimeout(() => {
        addLog('üìä Status final:', 'info');
        addLog(`   Prompt dispon√≠vel: ${deferredPrompt ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå'}`, deferredPrompt ? 'success' : 'warning');
        addLog(`   SW controlando: ${navigator.serviceWorker.controller ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå'}`, 
               navigator.serviceWorker.controller ? 'success' : 'warning');
    }, 5000);
});

// ==========================================
// MONITORAR MUDAN√áAS NO SW
// ==========================================
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.addEventListener('controllerchange', () => {
        addLog('üîÑ Novo Service Worker assumiu controle!', 'success');
        verificarInstalabilidade();
    });
}
</script>
