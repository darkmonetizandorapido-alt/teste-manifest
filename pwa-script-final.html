<!-- ===============================
 PWA SCRIPT - SEM LOOP INFINITO
 + FALLBACK MANUAL
=============================== -->
<script>
// ==========================================
// CONFIGURA√á√ÉO
// ==========================================
let deferredPrompt = null;
const PWA_DEBUG = true;
let verificacoesRealizadas = 0;
const MAX_VERIFICACOES = 5; // M√°ximo de tentativas

// ==========================================
// SISTEMA DE LOGS
// ==========================================
function addLog(message, type = 'info') {
    const statusDiv = document.getElementById('pwa-status');
    if (!statusDiv) {
        console.log(`[PWA] ${message}`);
        return;
    }
    
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
        info: '#2196F3',
        success: '#4CAF50',
        warning: '#FF9800',
        error: '#F44336'
    };
    
    const log = document.createElement('div');
    log.style.color = colors[type] || colors.info;
    log.textContent = `[${timestamp}] ${message}`;
    statusDiv.appendChild(log);
    statusDiv.scrollTop = statusDiv.scrollHeight;
    
    console.log(`%c[PWA] ${message}`, `color: ${colors[type]}; font-weight: bold`);
}

// ==========================================
// DETECTAR NAVEGADOR
// ==========================================
function detectarNavegador() {
    const ua = navigator.userAgent;
    let navegador = 'Desconhecido';
    
    if (ua.includes('Chrome') && !ua.includes('Edge')) navegador = 'Chrome';
    else if (ua.includes('Edg')) navegador = 'Edge';
    else if (ua.includes('Firefox')) navegador = 'Firefox';
    else if (ua.includes('Safari') && !ua.includes('Chrome')) navegador = 'Safari';
    
    const mobile = /Android|iPhone|iPad|iPod/i.test(ua);
    const ios = /iPhone|iPad|iPod/i.test(ua);
    
    return { navegador, mobile, ios };
}

// ==========================================
// VERIFICAR SUPORTE A INSTALA√á√ÉO
// ==========================================
function verificarSuporteInstalacao() {
    const { navegador, mobile, ios } = detectarNavegador();
    
    addLog(`üì± Navegador: ${navegador}${mobile ? ' (Mobile)' : ' (Desktop)'}`, 'info');
    
    if (ios) {
        addLog('‚ö†Ô∏è iOS detectado: beforeinstallprompt n√£o suportado', 'warning');
        addLog('üí° Instru√ß√µes: Safari ‚Üí Compartilhar ‚Üí Adicionar √† Tela Inicial', 'info');
        return false;
    }
    
    if (navegador === 'Firefox') {
        addLog('‚ö†Ô∏è Firefox n√£o suporta instala√ß√£o autom√°tica de PWA', 'warning');
        return false;
    }
    
    if (navegador === 'Safari') {
        addLog('‚ö†Ô∏è Safari desktop n√£o suporta instala√ß√£o de PWA', 'warning');
        return false;
    }
    
    addLog(`‚úÖ ${navegador} suporta instala√ß√£o de PWA`, 'success');
    return true;
}

// ==========================================
// REGISTRAR SERVICE WORKER
// ==========================================
async function registrarServiceWorker() {
    if (!('serviceWorker' in navigator)) {
        addLog('‚ùå Service Worker n√£o suportado', 'error');
        return null;
    }
    
    try {
        addLog('üìù Registrando Service Worker...', 'info');
        
        const registration = await navigator.serviceWorker.register('/service-worker.js', {
            scope: '/',
            updateViaCache: 'none'
        });
        
        addLog('‚úÖ Service Worker registrado', 'success');
        addLog(`   Scope: ${registration.scope}`, 'info');
        
        // Aguardar estar pronto
        await navigator.serviceWorker.ready;
        addLog('‚úÖ Service Worker est√° pronto', 'success');
        
        return registration;
        
    } catch (error) {
        addLog(`‚ùå Erro ao registrar SW: ${error.message}`, 'error');
        return null;
    }
}

// ==========================================
// VERIFICAR TUDO
// ==========================================
function verificarTudo() {
    const checklist = {
        'HTTPS/Localhost': window.location.protocol === 'https:' || window.location.hostname === 'localhost',
        'Service Worker Suportado': 'serviceWorker' in navigator,
        'Service Worker Ativo': !!navigator.serviceWorker.controller,
        'Manifest Presente': !!document.querySelector('link[rel="manifest"]'),
        'Notifica√ß√µes Suportadas': 'Notification' in window,
        'Permiss√£o de Notifica√ß√£o': Notification.permission,
        'beforeinstallprompt Capturado': !!deferredPrompt,
        'App em Standalone': window.matchMedia('(display-mode: standalone)').matches
    };
    
    const checklistDiv = document.getElementById('status-checklist');
    if (checklistDiv) {
        checklistDiv.innerHTML = '';
        
        for (const [key, value] of Object.entries(checklist)) {
            const item = document.createElement('div');
            item.className = 'status-item';
            
            let icon = '‚ùå';
            let status = value;
            
            if (typeof value === 'boolean') {
                icon = value ? '‚úÖ' : '‚ùå';
                status = value ? 'Sim' : 'N√£o';
            }
            
            item.innerHTML = `
                <span class="status-icon">${icon}</span>
                <strong>${key}:</strong>
                <span>${status}</span>
            `;
            
            checklistDiv.appendChild(item);
        }
    }
    
    return checklist;
}

// ==========================================
// VERIFICAR SE PODE INSTALAR
// ==========================================
async function verificarInstalabilidade() {
    // PREVENIR LOOP INFINITO
    verificacoesRealizadas++;
    if (verificacoesRealizadas > MAX_VERIFICACOES) {
        addLog('‚ö†Ô∏è M√°ximo de verifica√ß√µes atingido', 'warning');
        addLog('üí° O evento beforeinstallprompt pode n√£o disparar neste navegador/situa√ß√£o', 'info');
        mostrarInstrucoesManuais();
        return;
    }
    
    addLog(`üîç Verifica√ß√£o ${verificacoesRealizadas}/${MAX_VERIFICACOES}...`, 'info');
    
    // Verificar se j√° est√° instalado
    if (window.matchMedia('(display-mode: standalone)').matches) {
        addLog('‚úÖ App j√° est√° instalado!', 'success');
        return;
    }
    
    // Verificar se SW est√° ativo
    if (!navigator.serviceWorker.controller) {
        addLog('‚è≥ Aguardando Service Worker ficar ativo...', 'info');
        setTimeout(verificarInstalabilidade, 2000);
        return;
    }
    
    // Verificar se prompt est√° dispon√≠vel
    if (deferredPrompt) {
        addLog('‚úÖ Prompt de instala√ß√£o dispon√≠vel!', 'success');
        setTimeout(mostrarModalInstalar, 3000);
        return;
    }
    
    // Se n√£o disparou ainda, tentar novamente
    if (verificacoesRealizadas < MAX_VERIFICACOES) {
        addLog(`‚è≥ Aguardando beforeinstallprompt... (tentativa ${verificacoesRealizadas})`, 'info');
        setTimeout(verificarInstalabilidade, 3000);
    } else {
        mostrarInstrucoesManuais();
    }
}

// ==========================================
// INSTRU√á√ïES MANUAIS
// ==========================================
function mostrarInstrucoesManuais() {
    const { navegador, ios } = detectarNavegador();
    
    addLog('', 'info');
    addLog('üì± COMO INSTALAR MANUALMENTE:', 'warning');
    
    if (ios) {
        addLog('iOS Safari:', 'info');
        addLog('1. Toque no bot√£o Compartilhar (quadrado com seta)', 'info');
        addLog('2. Role e toque em "Adicionar √† Tela Inicial"', 'info');
        addLog('3. Toque em "Adicionar"', 'info');
    } else if (navegador === 'Chrome' || navegador === 'Edge') {
        addLog(`${navegador}:`, 'info');
        addLog('1. Clique nos 3 pontos (‚ãÆ) no canto superior direito', 'info');
        addLog('2. Clique em "Instalar aplicativo..." ou "Instalar [nome]"', 'info');
        addLog('3. Confirme a instala√ß√£o', 'info');
    } else {
        addLog('Use Chrome ou Edge para melhor experi√™ncia', 'info');
    }
    
    addLog('', 'info');
}

// ==========================================
// MODAL
// ==========================================
function mostrarModalInstalar() {
    const modal = document.getElementById("modal-instalar");
    if (modal) {
        modal.style.display = "flex";
        addLog('üì± Modal de instala√ß√£o exibido', 'success');
    }
}

function fecharModalInstalar() {
    const modal = document.getElementById("modal-instalar");
    if (modal) {
        modal.style.display = "none";
        addLog('‚úñÔ∏è Modal fechado', 'info');
    }
}

// ==========================================
// INSTALAR APP
// ==========================================
async function instalarAppManual() {
    if (!deferredPrompt) {
        addLog('‚ö†Ô∏è Instala√ß√£o autom√°tica n√£o dispon√≠vel', 'warning');
        mostrarInstrucoesManuais();
        return;
    }
    
    try {
        addLog('üì≤ Solicitando instala√ß√£o...', 'info');
        deferredPrompt.prompt();
        
        const choiceResult = await deferredPrompt.userChoice;
        
        if (choiceResult.outcome === 'accepted') {
            addLog('‚úÖ Usu√°rio aceitou instalar!', 'success');
        } else {
            addLog('‚ùå Usu√°rio recusou a instala√ß√£o', 'warning');
        }
        
        deferredPrompt = null;
        fecharModalInstalar();
        
    } catch (error) {
        addLog(`‚ùå Erro: ${error.message}`, 'error');
    }
}

// ==========================================
// NOTIFICA√á√ïES
// ==========================================
async function ativarNotificacoes() {
    if (!("Notification" in window)) {
        addLog('‚ùå Notifica√ß√µes n√£o suportadas', 'error');
        return;
    }
    
    try {
        const permission = await Notification.requestPermission();
        addLog(`üîî Permiss√£o: ${permission}`, permission === 'granted' ? 'success' : 'warning');
        
        if (permission === 'granted') {
            new Notification('‚úÖ Notifica√ß√µes Ativadas!', {
                body: 'Voc√™ receber√° atualiza√ß√µes de ora√ß√µes',
                icon: '/icon-192.png'
            });
        }
    } catch (error) {
        addLog(`‚ùå Erro: ${error.message}`, 'error');
    }
}

// ==========================================
// LIMPAR CACHE
// ==========================================
async function limparCache() {
    try {
        addLog('üóëÔ∏è Limpando cache...', 'info');
        
        if ('caches' in window) {
            const cacheNames = await caches.keys();
            await Promise.all(cacheNames.map(name => caches.delete(name)));
            addLog('‚úÖ Cache limpo', 'success');
        }
        
        if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            await Promise.all(registrations.map(reg => reg.unregister()));
            addLog('‚úÖ Service Workers desregistrados', 'success');
        }
        
        addLog('üîÑ Recarregando...', 'info');
        setTimeout(() => window.location.reload(true), 1000);
        
    } catch (error) {
        addLog(`‚ùå Erro: ${error.message}`, 'error');
    }
}

// ==========================================
// EVENTOS
// ==========================================
window.addEventListener("beforeinstallprompt", (e) => {
    addLog('üéâ beforeinstallprompt capturado!', 'success');
    e.preventDefault();
    deferredPrompt = e;
    
    verificarTudo();
    
    // Parar verifica√ß√µes j√° que o prompt est√° dispon√≠vel
    verificacoesRealizadas = MAX_VERIFICACOES;
    
    setTimeout(mostrarModalInstalar, 3000);
});

window.addEventListener('appinstalled', () => {
    addLog('üéä App instalado com sucesso!', 'success');
    fecharModalInstalar();
});

// ==========================================
// INICIALIZA√á√ÉO
// ==========================================
window.addEventListener('load', async () => {
    addLog('üöÄ Iniciando sistema PWA...', 'info');
    
    // 1. Detectar navegador
    const suporta = verificarSuporteInstalacao();
    
    // 2. Registrar SW
    await registrarServiceWorker();
    
    // 3. Verificar requisitos
    addLog('üîç Iniciando verifica√ß√£o completa...', 'info');
    const status = verificarTudo();
    addLog('‚úÖ Verifica√ß√£o conclu√≠da', 'success');
    
    // 4. Configurar bot√µes
    const btnInstalar = document.getElementById('btn-instalar');
    const btnInstalarModal = document.getElementById('btn-instalar-modal');
    
    if (btnInstalar) btnInstalar.addEventListener('click', instalarAppManual);
    if (btnInstalarModal) btnInstalarModal.addEventListener('click', instalarAppManual);
    
    addLog('‚ú® Sistema inicializado!', 'success');
    
    // 5. Iniciar verifica√ß√µes (se navegador suporta)
    if (suporta && status['Service Worker Ativo']) {
        setTimeout(verificarInstalabilidade, 2000);
    } else if (!suporta) {
        setTimeout(mostrarInstrucoesManuais, 2000);
    }
    
    // 6. Status final
    setTimeout(() => {
        addLog('üìä Status final:', 'info');
        addLog(`   Prompt dispon√≠vel: ${deferredPrompt ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå'}`, 
               deferredPrompt ? 'success' : 'warning');
        addLog(`   SW controlando: ${navigator.serviceWorker.controller ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå'}`, 
               navigator.serviceWorker.controller ? 'success' : 'warning');
    }, 8000);
});
</script>
